<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Echoes - 个人空间</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    /* 保持原有样式不变 */
    :root { --bg-color: #F5F3EF; --card-bg: #FFFFFF; --text-main: #333333; --text-sub: #666666; --accent-color: #E67E22; --btn-color: #4A4A4A; --btn-hover: #000000; --border-radius: 16px; --shadow: 0 4px 20px rgba(0,0,0,0.04); }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; padding: 40px 20px; }
    .container { display: grid; grid-template-columns: 320px 1fr; gap: 30px; width: 100%; max-width: 1100px; align-items: start; }
    .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 24px; transition: all 0.3s ease; }
    .left-sidebar { position: sticky; top: 40px; }
    .profile-card { text-align: center; }
    .avatar { width: 80px; height: 80px; background-color: #ddd; border-radius: 50%; margin: 0 auto 16px; background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Nolan'); background-size: cover; }
    .profile-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
    .profile-bio { font-size: 0.9rem; color: var(--text-sub); line-height: 1.6; }
    .editor-card { display: none; border: 2px solid var(--accent-color); }
    .editor-header { font-weight: bold; margin-bottom: 12px; color: var(--accent-color); display: flex; justify-content: space-between; align-items: center; }
    .input-title { width: 100%; border: none; background: #F9F9F9; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; font-weight: 500; outline: none; }
    #editor-container { height: 200px; background: #fff; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
    .ql-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .action-btn { width: 100%; margin-top: 15px; padding: 10px; border: none; background: var(--btn-color); color: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
    .action-btn:hover { background: var(--btn-hover); }
    .cancel-edit-btn { background: #ccc; color: #333; margin-top: 8px; display: none; }
    .feed-list { list-style: none; padding: 0; margin: 0; }
    .feed-item { margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px dashed #e0e0e0; position: relative; }
    .feed-item:last-child { border-bottom: none; }
    .post-meta { display: flex; align-items: center; font-size: 0.85rem; color: var(--accent-color); font-weight: 600; margin-bottom: 12px; }
    .post-meta::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; margin-right: 8px; }
    .post-title { font-size: 1.4rem; font-weight: 700; margin: 0 0 12px 0; color: #2c3e50; }
    .post-content { font-size: 1rem; line-height: 1.7; color: #444; }
    .post-content img { max-width: 100%; border-radius: 8px; }
    .post-content blockquote { border-left: 4px solid #ddd; padding-left: 16px; color: #777; margin: 16px 0; }
    .admin-controls { margin-top: 15px; display: none; gap: 10px; }
    .admin-btn { padding: 4px 12px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .btn-edit { color: var(--accent-color); border-color: var(--accent-color); }
    .btn-del { color: #e74c3c; border-color: #e74c3c; }
    .mode-switch { position: fixed; bottom: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.1); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 100; transition: background 0.3s; }
    .mode-switch:hover { background: var(--accent-color); color: #fff; }
    @media (max-width: 768px) { .container { grid-template-columns: 1fr; } .left-sidebar { position: relative; top: 0; margin-bottom: 20px;} }
  </style>
</head>
<body>

  <button class="mode-switch" id="modeSwitch" title="切换Admin模式">⚙️</button>

  <div class="container">
    <div class="left-sidebar">
      <div class="card profile-card" id="guestPanel">
        <div class="avatar"></div>
        <div class="profile-name">Nolan</div>
        <div class="profile-bio">
          New York University Shanghai<br><br>
          乐于探索哲学奥秘<br>寻找生命意义<br>热爱前沿科技<br>自由而有趣的灵魂
        </div>
      </div>

      <div class="card editor-card" id="adminPanel">
        <div class="editor-header">
          <span id="editorModeText">发布新内容</span>
          <small style="font-weight:normal; cursor:pointer;" onclick="switchMode()">退出Admin</small>
        </div>
        <input type="text" id="postTitle" class="input-title" placeholder="输入标题..." autocomplete="off">
        <div id="editor-container"></div>
        <input type="hidden" id="editingId" value="">
        <button class="action-btn" id="submitBtn">发布 Echo</button>
        <button class="action-btn cancel-edit-btn" id="cancelEditBtn">取消修改</button>
      </div>
    </div>

    <div class="main-feed">
      <ul class="feed-list" id="feedList">
        <div style="text-align:center; color:#999; padding:20px;">正在加载云端数据...</div>
      </ul>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // ==========================================
    // ⚠️⚠️⚠️ 请在这里填入你的 Supabase 配置 ⚠️⚠️⚠️
    // ==========================================
    const SUPABASE_URL = 'https://pukmwienoiknatnpzobk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1a213aWVub2lrbmF0bnB6b2JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTYyMjgsImV4cCI6MjA3OTg3MjIyOH0.OXSEMos-dlXKk0exU4e-ZKTFo2vxDpm5jRMCRGqSSp0';
    // ==========================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const ADMIN_PASS = "admin"; 
    const AUTH_KEY = "is_admin_mode";
    let cachedPosts = []; // 本地缓存

    // 初始化 Quill
    var quill = new Quill('#editor-container', {
      theme: 'snow',
      placeholder: '写点什么...',
      modules: { toolbar: [['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image', 'code-block']] }
    });

    // 1. 获取数据 (SELECT)
    async function fetchPosts() {
      const { data, error } = await supabase
        .from('posts')
        .select('*')
        .order('id', { ascending: false }); // 按ID倒序排列

      if (error) {
        console.error('Error fetching:', error);
        alert('读取数据失败，请检查控制台');
        return;
      }
      cachedPosts = data;
      renderFeed(data);
    }

    // 2. 渲染列表
    function renderFeed(posts) {
      const list = document.getElementById('feedList');
      list.innerHTML = '';
      
      if(posts.length === 0) {
        list.innerHTML = '<div style="text-align:center; color:#999;">暂无内容</div>';
        return;
      }

      const adminMode = localStorage.getItem(AUTH_KEY) === '1';

      posts.forEach(post => {
        const li = document.createElement('li');
        li.className = 'feed-item';
        const adminControls = adminMode ? `
          <div class="admin-controls" style="display:flex;">
            <button class="admin-btn btn-edit" onclick="editPost(${post.id})">编辑</button>
            <button class="admin-btn btn-del" onclick="deletePost(${post.id})">删除</button>
          </div>` : '';

        li.innerHTML = `
          <div class="post-meta">${post.date}</div>
          <h2 class="post-title">${post.title}</h2>
          <div class="post-content">${post.content}</div>
          ${adminControls}
        `;
        list.appendChild(li);
      });
      updateUIState();
    }

    // 3. 提交数据 (INSERT / UPDATE)
    document.getElementById('submitBtn').onclick = async function() {
      const title = document.getElementById('postTitle').value.trim();
      const content = quill.root.innerHTML;
      const textContent = quill.getText().trim();
      const editingId = document.getElementById('editingId').value;

      if (!title || !textContent) { alert("标题和内容不能为空"); return; }
      
      this.textContent = '提交中...';
      this.disabled = true;

      const now = new Date();
      const dateStr = formatDate(now);
      const rawDate = now.toISOString().split('T')[0];

      if (editingId) {
        // --- 更新 ---
        const { error } = await supabase
          .from('posts')
          .update({ title: title, content: content })
          .eq('id', editingId); // WHERE id = editingId
        
        if(error) alert('更新失败：' + error.message);
        else alert('更新成功！');

      } else {
        // --- 新增 ---
        // ID 建议使用时间戳，或者在 Supabase 设置里让 id 自增。这里手动生成 ID 模拟之前逻辑
        const newId = Date.now(); 
        const { error } = await supabase
          .from('posts')
          .insert([{ id: newId, title: title, content: content, date: dateStr, raw_date: rawDate }]);

        if(error) alert('发布失败：' + error.message);
        else alert('发布成功！');
      }

      this.textContent = editingId ? '保存修改' : '发布 Echo';
      this.disabled = false;
      resetEditor();
      fetchPosts(); // 重新拉取数据
    };

    // 4. 删除数据 (DELETE)
    window.deletePost = async function(id) {
      if(!confirm("确定要删除这条内容吗？")) return;
      
      const { error } = await supabase
        .from('posts')
        .delete()
        .eq('id', id);

      if(error) alert('删除失败：' + error.message);
      else {
        // 如果正在编辑的被删除了
        if(document.getElementById('editingId').value == id) resetEditor();
        fetchPosts();
      }
    };

    // 5. 编辑预填
    window.editPost = function(id) {
      const post = cachedPosts.find(p => p.id === id);
      if (!post) return;
      document.getElementById('postTitle').value = post.title;
      quill.root.innerHTML = post.content;
      document.getElementById('editingId').value = post.id;
      document.getElementById('editorModeText').textContent = "修改内容";
      document.getElementById('submitBtn').textContent = "保存修改";
      document.getElementById('cancelEditBtn').style.display = "block";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // 辅助函数
    function formatDate(dateObj) {
      const y = dateObj.getFullYear();
      const m = dateObj.getMonth() + 1;
      const d = dateObj.getDate();
      const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
      return `${y}年${m}月${d}日 · 周${weekDays[dateObj.getDay()]}`;
    }

    function resetEditor() {
      document.getElementById('postTitle').value = '';
      quill.root.innerHTML = '';
      document.getElementById('editingId').value = '';
      document.getElementById('editorModeText').textContent = "发布新内容";
      document.getElementById('submitBtn').textContent = "发布 Echo";
      document.getElementById('cancelEditBtn').style.display = "none";
    }

    function updateUIState() {
      const isAdm = localStorage.getItem(AUTH_KEY) === '1';
      document.getElementById('guestPanel').style.display = isAdm ? 'none' : 'block';
      document.getElementById('adminPanel').style.display = isAdm ? 'block' : 'none';
      
      // 显示/隐藏所有删除按钮
      const controls = document.querySelectorAll('.admin-controls');
      controls.forEach(el => el.style.display = isAdm ? 'flex' : 'none');
    }

    function switchMode() {
      if (localStorage.getItem(AUTH_KEY) === '1') {
        localStorage.setItem(AUTH_KEY, '0');
        resetEditor();
      } else {
        const pwd = prompt("请输入Admin密码 (默认: admin):");
        if (pwd === ADMIN_PASS) {
          localStorage.setItem(AUTH_KEY, '1');
        } else if (pwd !== null) alert("密码错误");
      }
      updateUIState();
    }
    
    document.getElementById('modeSwitch').onclick = switchMode;

    // 启动时加载
    fetchPosts();

  </script>
</body>
</html>

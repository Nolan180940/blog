<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Echoes - ä¸ªäººç©ºé—´</title>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
  <!-- å¼•å…¥ Supabase JS SDK -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  
  <style>
    /* ä¿æŒåŸæœ‰æ ·å¼ä¸å˜ */
    :root { --bg-color: #F5F3EF; --card-bg: #FFFFFF; --text-main: #333333; --text-sub: #666666; --accent-color: #E67E22; --btn-color: #4A4A4A; --btn-hover: #000000; --border-radius: 16px; --shadow: 0 4px 20px rgba(0,0,0,0.04); }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Noto Sans SC', sans-serif; background-color: var(--bg-color); color: var(--text-main); min-height: 100vh; display: flex; justify-content: center; padding: 40px 20px; }
    .container { display: grid; grid-template-columns: 320px 1fr; gap: 30px; width: 100%; max-width: 1100px; align-items: start; }
    .card { background: var(--card-bg); border-radius: var(--border-radius); box-shadow: var(--shadow); padding: 24px; transition: all 0.3s ease; }
    .left-sidebar { position: sticky; top: 40px; }
    .profile-card { text-align: center; }
    .avatar { width: 80px; height: 80px; background-color: #ddd; border-radius: 50%; margin: 0 auto 16px; background-image: url('https://api.dicebear.com/7.x/avataaars/svg?seed=Nolan'); background-size: cover; }
    .profile-name { font-size: 1.2rem; font-weight: 700; margin-bottom: 8px; }
    .profile-bio { font-size: 0.9rem; color: var(--text-sub); line-height: 1.6; }
    .editor-card { display: none; border: 2px solid var(--accent-color); }
    .editor-header { font-weight: bold; margin-bottom: 12px; color: var(--accent-color); display: flex; justify-content: space-between; align-items: center; }
    .input-title { width: 100%; border: none; background: #F9F9F9; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 1rem; font-weight: 500; outline: none; }
    #editor-container { height: 200px; background: #fff; border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }
    .ql-toolbar { border-top-left-radius: 8px; border-top-right-radius: 8px; }
    .action-btn { width: 100%; margin-top: 15px; padding: 10px; border: none; background: var(--btn-color); color: #fff; border-radius: 8px; cursor: pointer; font-size: 1rem; transition: background 0.2s; }
    .action-btn:hover { background: var(--btn-hover); }
    .cancel-edit-btn { background: #ccc; color: #333; margin-top: 8px; display: none; }
    .restore-btn { background: #E67E22; color: #fff; margin-top: 8px; font-size: 0.9rem;}
    .feed-list { list-style: none; padding: 0; margin: 0; }
    .feed-item { margin-bottom: 30px; padding-bottom: 30px; border-bottom: 1px dashed #e0e0e0; position: relative; }
    .feed-item:last-child { border-bottom: none; }
    .post-meta { display: flex; align-items: center; font-size: 0.85rem; color: var(--accent-color); font-weight: 600; margin-bottom: 12px; }
    .post-meta::before { content: ''; display: inline-block; width: 8px; height: 8px; background: var(--accent-color); border-radius: 50%; margin-right: 8px; }
    .post-title { font-size: 1.4rem; font-weight: 700; margin: 0 0 12px 0; color: #2c3e50; }
    .post-content { font-size: 1rem; line-height: 1.7; color: #444; }
    .post-content img { max-width: 100%; border-radius: 8px; }
    .post-content blockquote { border-left: 4px solid #ddd; padding-left: 16px; color: #777; margin: 16px 0; }
    .admin-controls { margin-top: 15px; display: none; gap: 10px; }
    .admin-btn { padding: 4px 12px; font-size: 0.8rem; border-radius: 4px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .btn-edit { color: var(--accent-color); border-color: var(--accent-color); }
    .btn-del { color: #e74c3c; border-color: #e74c3c; }
    .mode-switch { position: fixed; bottom: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; background: rgba(0,0,0,0.1); border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; z-index: 100; transition: background 0.3s; }
    .mode-switch:hover { background: var(--accent-color); color: #fff; }
    .error-msg { color: #e74c3c; text-align: center; padding: 20px; background: #fff0f0; border-radius: 8px; margin-top: 20px; }
    @media (max-width: 768px) { .container { grid-template-columns: 1fr; } .left-sidebar { position: relative; top: 0; margin-bottom: 20px;} }
  </style>
</head>
<body>

  <button class="mode-switch" id="modeSwitch" title="åˆ‡æ¢Adminæ¨¡å¼">âš™ï¸</button>

  <div class="container">
    <div class="left-sidebar">
      <div class="card profile-card" id="guestPanel">
        <div class="avatar"></div>
        <div class="profile-name">Nolan</div>
        <div class="profile-bio">
          New York University Shanghai<br><br>
          ä¹äºæ¢ç´¢å“²å­¦å¥¥ç§˜<br>å¯»æ‰¾ç”Ÿå‘½æ„ä¹‰<br>çƒ­çˆ±å‰æ²¿ç§‘æŠ€<br>è‡ªç”±è€Œæœ‰è¶£çš„çµé­‚
        </div>
      </div>

      <div class="card editor-card" id="adminPanel">
        <div class="editor-header">
          <span id="editorModeText">å‘å¸ƒæ–°å†…å®¹</span>
          <small style="font-weight:normal; cursor:pointer;" onclick="switchMode()">é€€å‡ºAdmin</small>
        </div>
        <input type="text" id="postTitle" class="input-title" placeholder="è¾“å…¥æ ‡é¢˜..." autocomplete="off">
        <div id="editor-container"></div>
        <input type="hidden" id="editingId" value="">
        <button class="action-btn" id="submitBtn">å‘å¸ƒ Echo</button>
        <button class="action-btn cancel-edit-btn" id="cancelEditBtn">å–æ¶ˆä¿®æ”¹</button>
        <hr style="margin: 15px 0; border:0; border-top:1px dashed #ddd;">
        <button class="action-btn restore-btn" onclick="restoreDefaultData()">ğŸ”„ ä¸€é”®æ¢å¤é»˜è®¤æ–‡ç« </button>
      </div>
    </div>

    <div class="main-feed">
      <ul class="feed-list" id="feedList">
        <div style="text-align:center; color:#999; padding:20px;">
            <div class="loader" style="display:inline-block; border: 3px solid #f3f3f3; border-top: 3px solid #E67E22; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite;"></div>
            <p>æ­£åœ¨è¿æ¥äº‘ç«¯...</p>
        </div>
      </ul>
    </div>
  </div>

  <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
  <script>
    // ==========================================
    // âš ï¸âš ï¸âš ï¸ è¯·åœ¨è¿™é‡Œé‡æ–°å¡«å…¥ä½ çš„ Supabase é…ç½® âš ï¸âš ï¸âš ï¸
    // ==========================================
    const SUPABASE_URL = 'https://pukmwienoiknatnpzobk.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1a213aWVub2lrbmF0bnB6b2JrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQyOTYyMjgsImV4cCI6MjA3OTg3MjIyOH0.OXSEMos-dlXKk0exU4e-ZKTFo2vxDpm5jRMCRGqSSp0';
    // ==========================================

    let supabase;
    try {
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } catch (e) {
        showError("Supabase åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚");
    }

    const ADMIN_PASS = "admin"; 
    const AUTH_KEY = "is_admin_mode";
    let cachedPosts = []; 

    var quill = new Quill('#editor-container', {
      theme: 'snow',
      placeholder: 'å†™ç‚¹ä»€ä¹ˆ...',
      modules: { toolbar: [['bold', 'italic', 'underline', 'strike'], [{ 'list': 'ordered'}, { 'list': 'bullet' }], ['link', 'image', 'code-block']] }
    });

    // 1. è·å–æ•°æ® (å¢å¼ºé”™è¯¯å¤„ç†)
    async function fetchPosts() {
      if (!supabase) return;
      
      try {
          const { data, error } = await supabase
            .from('posts')
            .select('*')
            .order('id', { ascending: false });

          if (error) {
            console.error('Fetch error:', error);
            showError(`æ•°æ®è¯»å–å¤±è´¥: ${error.message}<br>è¯·å°è¯•å» Supabase SQL Editor è¿è¡Œ "ALTER TABLE posts DISABLE ROW LEVEL SECURITY;"`);
            return;
          }
          
          if (!data || data.length === 0) {
              document.getElementById('feedList').innerHTML = `
                <div style="text-align:center; color:#999; padding:40px;">
                    <h3>ğŸ“­ è¿™é‡Œçš„ç¡®æ˜¯ç©ºçš„</h3>
                    <p>æ•°æ®åº“è¿æ¥æˆåŠŸï¼Œä½†é‡Œé¢æ²¡æœ‰æ–‡ç« ã€‚</p>
                    <p>è¯·ç‚¹å‡»å³ä¸‹è§’ âš™ï¸ è¿›å…¥ Adminï¼Œä½¿ç”¨â€œä¸€é”®æ¢å¤é»˜è®¤æ–‡ç« â€åŠŸèƒ½ã€‚</p>
                </div>`;
              return;
          }

          cachedPosts = data;
          renderFeed(data);
      } catch (err) {
          showError("å‘ç”ŸæœªçŸ¥é”™è¯¯: " + err.message);
      }
    }

    function showError(msg) {
        document.getElementById('feedList').innerHTML = `<div class="error-msg">âŒ ${msg}</div>`;
    }

    // 2. æ¸²æŸ“åˆ—è¡¨
    function renderFeed(posts) {
      const list = document.getElementById('feedList');
      list.innerHTML = '';
      const adminMode = localStorage.getItem(AUTH_KEY) === '1';

      posts.forEach(post => {
        const li = document.createElement('li');
        li.className = 'feed-item';
        const adminControls = adminMode ? `
          <div class="admin-controls" style="display:flex;">
            <button class="admin-btn btn-edit" onclick="editPost(${post.id})">ç¼–è¾‘</button>
            <button class="admin-btn btn-del" onclick="deletePost(${post.id})">åˆ é™¤</button>
          </div>` : '';

        li.innerHTML = `
          <div class="post-meta">${post.date}</div>
          <h2 class="post-title">${post.title}</h2>
          <div class="post-content">${post.content}</div>
          ${adminControls}
        `;
        list.appendChild(li);
      });
      updateUIState();
    }

    // 3. æäº¤æ•°æ®
    document.getElementById('submitBtn').onclick = async function() {
      const title = document.getElementById('postTitle').value.trim();
      const content = quill.root.innerHTML;
      const editingId = document.getElementById('editingId').value;

      if (!title) { alert("æ ‡é¢˜ä¸èƒ½ä¸ºç©º"); return; }
      
      this.textContent = 'æäº¤ä¸­...';
      this.disabled = true;

      const now = new Date();
      const dateStr = `${now.getFullYear()}å¹´${now.getMonth()+1}æœˆ${now.getDate()}æ—¥`;
      const rawDate = now.toISOString().split('T')[0];

      let error;
      if (editingId) {
        const res = await supabase.from('posts').update({ title, content }).eq('id', editingId);
        error = res.error;
      } else {
        const res = await supabase.from('posts').insert([{ id: Date.now(), title, content, date: dateStr, raw_date: rawDate }]);
        error = res.error;
      }

      this.disabled = false;
      this.textContent = editingId ? 'ä¿å­˜ä¿®æ”¹' : 'å‘å¸ƒ Echo';

      if(error) alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
      else {
          resetEditor();
          fetchPosts();
      }
    };

    // 4. ä¸€é”®æ¢å¤é»˜è®¤æ•°æ® (æ•‘å‘½åŠŸèƒ½)
    window.restoreDefaultData = async function() {
        if(!confirm("ç¡®å®šè¦é‡æ–°å†™å…¥é»˜è®¤çš„4ç¯‡æ–‡ç« å—ï¼Ÿè¿™ä¸ä¼šåˆ é™¤ç°æœ‰æ–‡ç« ï¼Œåªä¼šå¢åŠ æ–°æ–‡ç« ã€‚")) return;
        
        const defaultPosts = [
          { id: 1764258833297, title: "2025/11/27", date: "2025å¹´11æœˆ27æ—¥ Â· å‘¨å››", raw_date: "2025-11-27", content: "<p>æœ‰æ—¶ï¼Œæˆ‘è§‰å¾—ä¸–ç•Œæ˜¯æ›´é«˜ç»´åº¦çš„...</p>" },
          { id: 1764258740402, title: "é¡¹ç›®ä½œå“é“¾æ¥", date: "2025å¹´11æœˆ27æ—¥ Â· å‘¨å››", raw_date: "2025-11-27", content: "<ul><li><a href='#'>æˆ‘çš„äº‘ç›˜</a></li></ul>" },
          { id: 1764258538030, title: "ä¸€äº›æ€è€ƒ", date: "2025å¹´11æœˆ27æ—¥ Â· å‘¨å››", raw_date: "2025-11-27", content: "<p>äººç”Ÿè’è¯ï¼Œå­˜åœ¨å…ˆäºæœ¬è´¨...</p>" },
          { id: 1764258281668, title: "Hello World", date: "2025å¹´11æœˆ27æ—¥ Â· å‘¨å››", raw_date: "2025-11-27", content: "<p>æˆ‘æ˜¯ Nolan...</p>" }
        ];

        let successCount = 0;
        for (let post of defaultPosts) {
            // å…ˆæ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨æ‰æ’å…¥ï¼Œé˜²æ­¢ä¸»é”®å†²çª
            const check = await supabase.from('posts').select('id').eq('id', post.id);
            if (check.data && check.data.length === 0) {
                await supabase.from('posts').insert([post]);
                successCount++;
            }
        }
        
        alert(`æ¢å¤å®Œæˆï¼å†™å…¥äº† ${successCount} ç¯‡æ–‡ç« ã€‚`);
        fetchPosts();
    };

    // è¾…åŠ©åŠŸèƒ½
    window.deletePost = async function(id) {
      if(!confirm("åˆ é™¤?")) return;
      const { error } = await supabase.from('posts').delete().eq('id', id);
      if(error) alert('åˆ é™¤å¤±è´¥: ' + error.message);
      else fetchPosts();
    };

    window.editPost = function(id) {
      const post = cachedPosts.find(p => p.id === id);
      if (!post) return;
      document.getElementById('postTitle').value = post.title;
      quill.root.innerHTML = post.content;
      document.getElementById('editingId').value = post.id;
      document.getElementById('editorModeText').textContent = "ä¿®æ”¹å†…å®¹";
      document.getElementById('submitBtn').textContent = "ä¿å­˜ä¿®æ”¹";
      document.getElementById('cancelEditBtn').style.display = "block";
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    function resetEditor() {
      document.getElementById('postTitle').value = '';
      quill.root.innerHTML = '';
      document.getElementById('editingId').value = '';
      document.getElementById('editorModeText').textContent = "å‘å¸ƒæ–°å†…å®¹";
      document.getElementById('submitBtn').textContent = "å‘å¸ƒ Echo";
      document.getElementById('cancelEditBtn').style.display = "none";
    }

    function updateUIState() {
      const isAdm = localStorage.getItem(AUTH_KEY) === '1';
      document.getElementById('guestPanel').style.display = isAdm ? 'none' : 'block';
      document.getElementById('adminPanel').style.display = isAdm ? 'block' : 'none';
      const controls = document.querySelectorAll('.admin-controls');
      controls.forEach(el => el.style.display = isAdm ? 'flex' : 'none');
    }

    function switchMode() {
      if (localStorage.getItem(AUTH_KEY) === '1') {
        localStorage.setItem(AUTH_KEY, '0');
        resetEditor();
      } else {
        const pwd = prompt("è¯·è¾“å…¥Adminå¯†ç  (é»˜è®¤: admin):");
        if (pwd === ADMIN_PASS) {
          localStorage.setItem(AUTH_KEY, '1');
        } else if (pwd !== null) alert("å¯†ç é”™è¯¯");
      }
      updateUIState();
      // åˆ‡æ¢æ¨¡å¼æ—¶é‡æ–°æ¸²æŸ“åˆ—è¡¨ä»¥æ˜¾ç¤º/éšè—æ“ä½œæŒ‰é’®
      renderFeed(cachedPosts);
    }
    
    document.getElementById('modeSwitch').onclick = switchMode;
    document.getElementById('cancelEditBtn').onclick = resetEditor;

    // å¯åŠ¨
    fetchPosts();

  </script>
</body>
</html>

